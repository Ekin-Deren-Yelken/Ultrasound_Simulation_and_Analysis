# Ultrasound_Simulation_and_Analysis

Three projects related Ultrasound Simulation and Analysis.

# Ultrasound.m

## Overview
Imagine you're standing by a road and listening to a car as it drives past you it goes EEEEooowwww.
- As the car **approaches**, the sound of the engine **gets higher-pitched** (higher frequency).
- As the car **moves away**, the sound **drops in pitch** (lower frequency).

This is called the **Doppler Effect**, and it’s exactly how **Doppler ultrasound** works!

Now, instead of a car, imagine tiny red blood cells moving inside a blood vessel. The blood cells are like cars on a highway and the ultrasound is like a speedgun.
- An ultrasound machine sends sound waves into the body.
- These waves bounce off moving blood cells and return with a shifted frequency based on blood speed.
- By analyzing how the frequency changes over time, we can estimate how fast the blood is flowing—just like hearing a car change pitch as it passes by.

### How This Project Works

1. **I simulate an ultrasound machine.**  
   - Generate a signal that **mimics real ultrasound waves** reflecting off moving blood.

2. **I introduce real-world problems (noise).**  
   - In real life, ultrasound signals get **distorted** by noise from the body, electronics, and the environment.
   - Add these noise sources to make our simulation **realistic**.

3. **I try to "clean" the signal to recover useful information.**  
   - Use different **filtering techniques** to remove noise.

4. **I extract blood velocity.**  
   - Instead of **listening** to frequency changes, we **mathematically analyze phase shifts** to measure how blood speed changes over time.

Doppler ultrasound is a critical tool in medical imaging used to measure blood flow velocity based on frequency shifts in received echoes.

### Data
The received Doppler ultrasound signal was generated by simulating the effect of blood velocity on a transmitted ultrasound wave. The process involved:
1. Defining a pulse train to mimic heartbeats, controlling when blood flow is active.
2. Using mathematical functions (logarithmic decay and exponential rise) to model the velocity profile of blood flow during systole and diastole.
3. Computing the Doppler frequency shift based on the blood velocity and ultrasound parameters.
4. Generating the received signal by modulating a 2 MHz carrier wave with the computed Doppler frequency shift.

#### Key Parameters and Their Role
| Parameter          | Description |
|--------------------|-------------|
| **HR = 75 bpm** | Heart rate (75 beats per minute), determines cycle repetition. |
| **PSV = 1 m/s** | Peak systolic velocity, the highest blood speed during systole. |
| **EDV = 0.3 m/s** | End diastolic velocity, the lower bound of blood speed. |
| **f_sample = 250 kHz** | Sampling rate for the simulated signal. |
| **f_o = 2 MHz** | Ultrasound carrier frequency. |
| **c = 1540 m/s** | Speed of sound in tissue, affects Doppler equation. |
| **θ = 60°** | Doppler angle, affects how velocity translates into frequency shift. |
| **A1, B1, C1** | Logarithmic function parameters for **systolic decay** (0.1s–0.533s). |
| **A2, B2, C2, D2** | Exponential function parameters for **initial systolic acceleration** (0s–0.1s). |
| **Pulse train** | Ensures **flow is periodic**, with **0.533s of blood flow per 0.8s heartbeat cycle**. |

![DATA](https://github.com/user-attachments/assets/6888b9b1-bada-4f41-804d-45c9699afdf6)

For some reason, with the current code version, when the velocity starts at 0 and the results are less accurate. When the resutls change teh same amount but start at 0.3 m/s they are most accurate. 

As this is not meant to be a hyper realistic study, I will just continue with the following data as teh return on debugging the issue doesn't seem high enough.


---

#### Doppler Shift and Received Signal
The Doppler shift was computed using:

$$
f_{doppler} = \frac{2 f_o V_{blood} \cos(\theta)}{c}
$$

where:
- $V_{blood}$: Computed from the velocity model.
- $f_o$ (2 MHz): The ultrasound transducer frequency.
- $\theta$ (60°): The angle of insonation.
- $c$ (1540 m/s): The speed of sound in tissue.

Then, the **received signal was synthesized** as:

$$
S(t) = \cos(2\pi f_o t + \phi(t))
$$

where $ \phi(t) $ is the phase modulation from the Doppler shift:

$$
\phi(t) = 2\pi \int_0^t f_{doppler}(\tau) d\tau
$$

## Implementation
To model the intput signal, consider the input data. If we were interested in the instataneous frequency, $f_{\text{inst}}$, then we could simply add the transducer's initial frequency and the doppler shift $f_{\text{inst}} = f_{\text{o}} + f_{\text{doppler}}$. However, due to the heartbeat, the doppler shift changes over time, we need to account for how the phase accumilates over time for this signal. Since instantaneous frequency is the derivative of phase, the only way to correctly model the received signal is to modulate it as a sinusoid with a time-varying phase.

$$
\textbf{received signal} = \cos\left(2\pi\, f_{\text{doppler}}\, t + \phi\right)
$$

where $\phi$ is the phase shift

$$
\phi[n] = 2\pi \sum_{k=0}^{n} \frac{f_{\text{doppler}}[k]}{f_{\text{sample}}}
$$

where $f_\text{sample}$ is the sampling frequency.

If the doppler shift was constant, for example viewing a star through a tellescope experiencing red or blueshift, the phase would grow linearly over time. 

However, when we calculate phi using our $f_\text{doppler}$ data, we can see the non-linear phase growth.

![Phase-Variations](https://github.com/user-attachments/assets/59cc8961-e347-46d4-85ca-71054d8d9c4c)

After applying the cosine function and phi function to our data, we obtain a sinusoidal signal. Note that the signal is truncated to cover a small fraction of time so the chanes are clearly visible.

![BFV1](https://github.com/user-attachments/assets/418a5ced-8564-4c84-827f-21b4a5a7a229)

In this project, to approach a real world scenario, noise is added into the signal. The section below decisions and analysis related to noise.


### Noise
In an ideal scenario, the Doppler frequency shift due to blood flow would produce a clean sinusoidal waveform (assuming a steady, periodic flow pattern). In reality, many types of noise can affect the signal. Common types of noise that are explored in this project include Clutter Tissue Motion Artifacts, Thermal Noise, Electrical Noise, and Speckle Noise. Other sources which were not included but could be further explored include Aliasing, Multipath Artifacts, and Phase Noise.


#### Clutter Noise
##### How Tissue Motion Contributes to the Doppler Signal
Moving vessel walls, surrounding tissues, and probe motion all generate low-frequency Doppler shifts (much lower than those from blood flow). These unwanted signals overlap with the desired blood flow signal, especially at low velocities.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
If we start with an ideal sinusoidal Doppler signal:

$$
s(t) = A \sin(2\pi f_{\text{dop}} t)
$$

where:
- $A$ is the amplitude of the signal,
- $f_{\text{dop}}$ is the Doppler frequency shift,
- $t$ is time.

Tissue motion introduces a low-frequency component:

$$
s_{\text{clutter}}(t) = A_1 \sin(2\pi f_{\text{clutter}} t + \phi_1)
$$

where:
- $A_1$ is the amplitude of the clutter signal (often large due to strong reflections from tissues),
- $f_{\text{clutter}}$ is the clutter frequency, which is much lower than the Doppler frequency (\( f_{\text{clutter}} \ll f_{\text{dop}} \)),
- $\phi_1$ is a phase shift.

![output](https://github.com/user-attachments/assets/3f5d0dcc-7dc2-4f8e-9c13-bb4efc63c00d)

##### How to Remove Clutter
Since clutter is low-frequency, the standard solution is a high-pass filter (Wall Filter).


#### Thermal Noise
Thermal and electronic noise originate from the hardware components of the ultrasound system, Johnson-Nyquist noise, Amplifier noise, Power Lines, and ADC sampling jitter. They introuce a random broadband component, affecting teh signal

##### How Thermal Noise Contributes to the Doppler Signal
In the time domain it appears as a random high-frequency broadband flucuatiation added to the Doppler signal. In the frequency domain, this manifests as white noise spread evenly across allf requencies. Moreover, the power spectral density (PSD) is flat meaning affects both low and high frequencies alike.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
A common model is **additive white Gaussian noise (AWGN)**:

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) + n_{\text{thermal}}(t)
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $n_{\text{thermal}}(t) \sim \mathcal{N}(0, \sigma^2)$ is a **Gaussian-distributed noise process**.

![output (1)](https://github.com/user-attachments/assets/08b8efc5-4783-4b5e-8bcf-f7fd08dfff4d)

##### How to Remove Thermal Noise
Unlike clutter noise, which is low-frequency, thermal noise affects the entire spectrum and requires techniques such as wavelet denoising or a low-pass filter.


#### Power Line Noise
This is a type of narrowband periodic noise, unlike thermal noise around 60 Hz which appears as oscillations in teh time-domain signal. It often includes harmonics due to the nonlinear circuit behaviour.

##### How Thermal and Electric Noise Contributes to the Doppler Signal
In the time domain it appears as a random high-frequency broadband flucuatiation added to the Doppler signal. In the frequency domain, this manifests as white noise spread evenly across allf requencies. Moreover, the power spectral density (PSD) is flat meaning affects both low and high frequencies alike.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
The received noisy signal can be expressed as:

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) + A_{\text{elec}} \cos(2\pi f_{\text{elec}} t + \phi)
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $A_{\text{elec}}$ is the amplitude of the electrical interference.
- $f_{\text{elec}} = 60$ Hz (or 50 Hz) is the power line frequency.
- $\phi$ is a phase offset.

##### How Power Line Noise Contributes to the Doppler Signal
At a single frequency is siuper imposed on the Doippler signal.

##### How to Remove Power Line Noise
Since it is a single frequency, a notch filter tuned to the frequency ill eliminate that section. Wavelet demoising is a more advanced technique which can help.


#### Speckle Noise
Speckle noise is a granular, high-frequency noise that occurs due to interference of scattered ultrasound waves. It is a multiplicative and can be caused by choerent wave interference (waves scattering of scrtuctures), phase diferences between scattering paths, and tissue texture variations which affect acoustic impedance.

##### How Speckle Noise Contributes to the Doppler Signal
Unlike thermal noise (which is additive), speckle noise is multiplicative, meaning it affects the signal strength depending on the amplitude of the underlying signal.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
In the Time-Domain, the Doppler signal experiences random amplitude fluctations, appearing to fade iun and out making weak blood flow/signal difficult to detect. In the Frequency-Domain, due to the non-sigular frequency effect, it appears as broad-band noise distroting spectral energy across various frequencies.

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) \cdot (1 + n_{\text{speckle}}(t))
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $n_{\text{speckle}}(t)$ is a random noise process, often modeled as a Rayleigh or log-normal distribution.

![output (2)](https://github.com/user-attachments/assets/750e4d03-37c4-4273-8a6c-d879d9f31d5e)

##### How to Remove Speckle Noise
Median filtering reduces localized speckle effects, but more robust techniques include wavelet denoising and adaptive filtering. Log compression can also make it easier to filter as it converts multiplicative noise into additive noise which is easier to filter.

### Further Notes for Noise Implementation
In a realistic Doppler ultrasound scenario, all these noise sources occur simultaneously but affect the signal at different stages of acquisition. To simulate noise realistically, a specific order is chosen to apply the noise. This is done to mimic the order these noise sources naturally affects the signal in a real ultrasound system.

Clutter Noise
- Clutter comes from large moving tissues (vessel walls, probe motion), which interfere with the received Doppler signal before it is processed.
- A low-frequ4ency sinusoid is added (~0.5-1.0) Hz with an amplitude larger than
Power Line Interference
- Power line noise  is introduced by nearby electrical sources before digitization. A 60 Hz sinusoidal component as added to the Doppler Signal.
Thermal Noise
- Thermal noise originates from hardware components (amplifiers, sensors, ADC quantization errors) and is typically added right before or during digitization. Gaussian white noise is added dependant on a sigma value.
Speckle Noise
-  Speckle noise is an acoustic interference effect that happens after wave propagation and scattering in tissue. It appears multiplicatively on the received signal as a Rayleigh-distributed random noise factor multiplied to the signal.

### Spectral Analysis
As we have added powerline noise at 60 Hz, clutter noise at 0.5 Hz, and thermal and clutter noise contributing to white noise and an increase in activity all around the frequency spectrum, we should expect to see spikes in teh FFT at these frequencies in addition to general activity across the spectrum.

After taking the FFT and applying a simple peak finding algorithim, the results are as expected, with an extra peak at 779 Hz. This frequency is likely due to the raw doppler shift.

![FFT-Peaks](https://github.com/user-attachments/assets/9984e30d-a392-42b3-9685-4021a96f910b)

### Filtering and Denoising
To remove noise and irrelevant information from the spectral analysis and confirm our assumption of the raw doppler shift frequency, we can apply some of the filter and denoising techniques discussed in the *Noise* section.

To minimize the amount of data lost and effectively remove noise, the goal is to use as few filters as possible. Moreover, these filters will be applied in a specific order to perserve as much information as possible.

1. High-Pass Filter to removes Clutter Noise: Eliminates the low-frequency components without affecting blood flow signals.
2. Notch filter to removes Electrical Noise: Eliminates the noise components at a specific frequency which is already known to us (50-60 Hz) will avoid affecting blood flow signals.
3. Wavelet Denoising to remove Speckle and Thermal Noise: Eliminates random and broadband noise. Wavelet shrinkage is applied last to smooth the signal while perserving sharp transitions in Doppler Shifts.

##### High Pass Filter
![filter1](https://github.com/user-attachments/assets/0d43ae9b-6715-4608-8a7f-946473b0e83b)

##### Notch FIlter
![filter2](https://github.com/user-attachments/assets/b8a0db1c-ef5c-4af3-9721-c42805022410)

#### Resulting FFT
After applying the filters, as predicted, the remaining 779 Hz frequency appears to pertain to the Doppler frequency data as seen in the FFT.

![BFV-FFT](https://github.com/user-attachments/assets/0646d15e-7c9d-4403-9690-5696a69e862b)

### Signal Reconstruction via Wavelet Denoising and Doppler Ultrasound Processing

In Doppler ultrasound, the received signal is typically a noisy, modulated version of the true Doppler-shifted signal. The goal of signal reconstruction is to recover the underlying phase and frequency information that encodes the blood velocity. Our approach involves several key steps:

#### 1. Wavelet Denoising

The first step is to reduce the noise present in the received signal using a wavelet-based denoising method. The wavelet transform allows us to decompose the signal into various time-frequency components.

Given a signal $s(t)$ we compute its wavelet decomposition:

$$
C = W(s(t))
$$

where $W$ is the wavelet transform operator (for example, using a Daubechies wavelet such as `db4`).

Next, we perform thresholding on the coefficients to suppress noise. A common choice is soft thresholding:

$$
\tilde{C}(k) = \text{sign}(C(k)) \cdot \max\big(|C(k)| - T, 0)
$$

where $T$ is a threshold, often determined via noise estimation (e.g., using the median absolute deviation).

Finally, we reconstruct the denoised signal using the inverse wavelet transform:

$$
\tilde{s}(t) = \mathcal{W}^{-1}\{ \tilde{C} \}
$$

#### 2. Instantaneous Phase and Amplitude Extraction

Once we have the denoised signal $\tilde{s}(t)$, we extract its instantaneous characteristics by computing the analytic signal via the Hilbert transform:

$$
a(t) = \tilde{s}(t) + i\,\mathcal{H}\{\tilde{s}(t)\}
$$

where $\mathcal{H}$ denotes the Hilbert transform.

From the analytic signal, we extract the instantaneous amplitude and phase:

$$
A(t) = |a(t)|, \quad \phi(t) = \text{unwrap}\{\arg(a(t))\}
$$

The instantaneous frequency is then obtained by differentiating the phase:

$$
f(t) = \frac{1}{2\pi}\frac{d\phi(t)}{dt}
$$

#### 3. Signal Reconstruction

Using the extracted instantaneous phase (and optionally the amplitude), we can reconstruct a version of the original signal. There are two common alternatives:

- **Preserving Amplitude Modulation:**  
  The reconstructed signal is given by
  
$$
\tilde{s}_{\text{recon}}(t) = A(t) \cos\big(\phi(t)\big)
$$

- **Constant Amplitude Reconstruction:**  
  To focus solely on the phase (which carries the Doppler frequency information), one may force the amplitude to be constant:
  
$$
\tilde{s}_{\text{recon}}(t) = \cos\big(\phi(t)\big)
$$
  
  This guarantees that the signal is confined to the range $[-1,1]$.

#### 4. Doppler Equation and Blood Velocity Estimation

In Doppler ultrasound, the frequency shift $f_{\text{doppler}}$ is related to the blood velocity $V$ by the equation

$$
f_{\text{doppler}} = \frac{2 f_{\text{transmit}}\, V\, \cos(\theta)}{c}
$$

where:
- $f_{\text{transmit}}$ is the transmitted ultrasound frequency,
- $\theta$ is the insonation angle,
- $c$ is the speed of sound in tissue.

Solving for $V$, we have:

$$
V = \frac{f_{\text{doppler}}\, c}{2 f_{\text{transmit}}\, \cos(\theta)}
$$

In our reconstruction, the instantaneous frequency $f(t)$ (derived from the phase derivative) acts as $f_{\text{doppler}}$, so we compute:

$$
V(t) = \frac{f(t)\, c}{2 f_{\text{transmit}}\, \cos(\theta)}
$$

If you later convert $V(t)$ from meters per second to centimeters per second, recall that

$$
1\ \text{m/s} = 100\ \text{cm/s}
$$

Here we can see the reconstruction of the phase and magnitude
![signal_reconstruction](https://github.com/user-attachments/assets/505c0d25-9831-4dad-ba1f-83671ee7807d)


---

### Design Decisions and Alternatives

- **Choice of Wavelet:**  
  We often choose a Daubechies wavelet (e.g., `db4`) because it offers a good balance between time and frequency resolution. Alternatives such as Symlets or Coiflets may be considered if better symmetry or smoother wavelets are desired.

- **Thresholding Strategy:**  
  Soft thresholding is used here because it tends to yield smoother reconstructions compared to hard thresholding. Other methods such as SureShrink or Bayesian thresholding could be applied depending on noise characteristics.

- **Instantaneous Phase Extraction:**  
  The Hilbert transform is widely used for extracting the analytic signal. However, if the signal is multicomponent or highly nonstationary, methods like the Continuous Wavelet Transform (CWT) with ridge extraction or synchrosqueezing can be more robust.

- **Smoothing of Instantaneous Frequency:**  
  The raw derivative of the unwrapped phase may contain rapid oscillations due to noise or the carrier. In practice, one might apply a smoothing filter (e.g., a moving average or Savitzky–Golay filter) to obtain a more stable estimate of $f(t)$.

- **Reconstruction Alternatives:**  
  - If preserving amplitude modulation is critical (e.g., if the amplitude carries additional diagnostic information), reconstructing using $A(t)$ is preferred.  
  - If only the Doppler shift (i.e., phase information) is of interest, forcing a constant amplitude simplifies the analysis and avoids amplitude-related artifacts.

### Spectogram

For blood flow, it is expected to see a clear line between 0-5 Hz.
![spectrogram](https://github.com/user-attachments/assets/db7208f7-572c-4d0e-8fa2-ec1bacad980f)

### Final Blood Velocity Results
The blood velocity from the data (ground truth) is overlayed on top of the reconstructed blood velocity
![final result](https://github.com/user-attachments/assets/bbe8f29f-6817-45eb-bce3-0ca264da7668)


## Validation

Using a coefficient correlation function between the reconstruction, noisy, and theoretical signals we get teh following values where 1 pertains to a higher correlation.

Correlation Coefficient (Reconstructed vs. Theory): 0.81249
Correlation Coefficient (Noise vs. Theory): 0.50668

Clearly, The reconstruction is successful, increasing the correlation by over 50%, however, it is quite low overall and would likely not be good enough for medical use. For the purposes of learning and that I have no clinical or technical expertise (yet) on this subject matter I think this is good enough as there is a very clear visual correlation as seen in the last image.

## What I learned
This stuff is really hard, very dependant on good data. A lot of design decisions on filtering and windowing, etc. need to be made. But it is very powerful, using pretty simple tools I made somethign pretty cool. Despite having perfect starting conditions, I still lost information in the process so I can't imagine how amazing the real life stuff has to be.
