# Ultrasound_Simulation_and_Analysis

Three projects related Ultrasound Simulation and Analysis.

# Ultrasound.m

## Overview
Doppler ultrasound is a critical tool in medical imaging used to measure blood flow velocity based on frequency shifts in received echoes. This code attempts to explore some of the 

### Data
The received Doppler ultrasound signal was generated by simulating the effect of blood velocity on a transmitted ultrasound wave. The process involved:
1. Defining a pulse train to mimic heartbeats, controlling when blood flow is active.
2. Using mathematical functions (logarithmic decay and exponential rise) to model the velocity profile of blood flow during systole and diastole.
3. Computing the Doppler frequency shift based on the blood velocity and ultrasound parameters.
4. Generating the received signal by modulating a 2 MHz carrier wave with the computed Doppler frequency shift.

#### Key Parameters and Their Role
| Parameter          | Description |
|--------------------|-------------|
| **HR = 75 bpm** | Heart rate (75 beats per minute), determines cycle repetition. |
| **PSV = 1 m/s** | Peak systolic velocity, the highest blood speed during systole. |
| **EDV = 0.3 m/s** | End diastolic velocity, the lower bound of blood speed. |
| **f_sample = 250 kHz** | Sampling rate for the simulated signal. |
| **f_o = 2 MHz** | Ultrasound carrier frequency. |
| **c = 1540 m/s** | Speed of sound in tissue, affects Doppler equation. |
| **θ = 60°** | Doppler angle, affects how velocity translates into frequency shift. |
| **A1, B1, C1** | Logarithmic function parameters for **systolic decay** (0.1s–0.533s). |
| **A2, B2, C2, D2** | Exponential function parameters for **initial systolic acceleration** (0s–0.1s). |
| **Pulse train** | Ensures **flow is periodic**, with **0.533s of blood flow per 0.8s heartbeat cycle**. |

---

#### Doppler Shift and Received Signal
The **Doppler shift was computed** using:

$$
f_{doppler} = \frac{2 f_o V_{blood} \cos(\theta)}{c}
$$

where:
- $V_{blood}$: Computed from the velocity model.
- $f_o$ (2 MHz): The ultrasound transducer frequency.
- $\theta$ (60°): The angle of insonation.
- $c$ (1540 m/s): The speed of sound in tissue.

Then, the **received signal was synthesized** as:

$$
S(t) = \cos(2\pi f_o t + \phi(t))
$$

where $ \phi(t) $ is the **phase modulation from the Doppler shift**:

$$
\phi(t) = 2\pi \int_0^t f_{doppler}(\tau) d\tau
$$

### Noise
In an ideal scenario, the Doppler frequency shift due to blood flow would produce a clean sinusoidal waveform (assuming a steady, periodic flow pattern). In reality, many types of noise can affect the signal. Common types of noise that are explored in this project include Clutter Tissue Motion Artifacts, Thermal Noise, Electrical Noise, and Speckle Noise. Other sources which were not included but could be further explored include Aliasing, Multipath Artifacts, and Phase Noise.

#### Clutter Noise
##### How Tissue Motion Contributes to the Doppler Signal
Moving vessel walls, surrounding tissues, and probe motion all generate low-frequency Doppler shifts (much lower than those from blood flow). These unwanted signals overlap with the desired blood flow signal, especially at low velocities.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
If we start with an ideal sinusoidal Doppler signal:
$$
s(t) = A \sin(2\pi f_{\text{dop}} t)
$$

where:
- $A$ is the amplitude of the signal,
- $f_{\text{dop}}$ is the Doppler frequency shift,
- $t$ is time.

Tissue motion introduces a low-frequency component:

$$
s_{\text{clutter}}(t) = A_1 \sin(2\pi f_{\text{clutter}} t + \phi_1)
$$

where:
- $A_1$ is the amplitude of the clutter signal (often large due to strong reflections from tissues),
- $f_{\text{clutter}}$ is the clutter frequency, which is much lower than the Doppler frequency (\( f_{\text{clutter}} \ll f_{\text{dop}} \)),
- $\phi_1$ is a phase shift.

![output](https://github.com/user-attachments/assets/3f5d0dcc-7dc2-4f8e-9c13-bb4efc63c00d)

##### How to Remove Clutter
Since clutter is low-frequency, the standard solution is a high-pass filter (Wall Filter).

#### Thermal Noise

Thermal and electronic noise originate from the hardware components of the ultrasound system, Johnson-Nyquist noise, Amplifier noise, Power Lines, and ADC sampling jitter. They introuce a random broadband component, affecting teh signal

##### How Thermal Noise Contributes to the Doppler Signal
In the time domain it appears as a random high-frequency broadband flucuatiation added to the Doppler signal. In the frequency domain, this manifests as white noise spread evenly across allf requencies. Moreover, the power spectral density (PSD) is flat meaning affects both low and high frequencies alike.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
A common model is **additive white Gaussian noise (AWGN)**:

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) + n_{\text{thermal}}(t)
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $n_{\text{thermal}}(t) \sim \mathcal{N}(0, \sigma^2)$ is a **Gaussian-distributed noise process**.

![output (1)](https://github.com/user-attachments/assets/08b8efc5-4783-4b5e-8bcf-f7fd08dfff4d)

##### How to Remove Thermal Noise
Unlike clutter noise, which is low-frequency, thermal noise affects the entire spectrum and requires techniques such as wavelet denoising or a low-pass filter.

#### Power Line Noise

This is a type of narrowband periodic noise, unlike thermal noise around 60 Hz which appears as oscillations in teh time-domain signal. It often includes harmonics due to the nonlinear circuit behaviour.

##### How Thermal and Electric Noise Contributes to the Doppler Signal
In the time domain it appears as a random high-frequency broadband flucuatiation added to the Doppler signal. In the frequency domain, this manifests as white noise spread evenly across allf requencies. Moreover, the power spectral density (PSD) is flat meaning affects both low and high frequencies alike.

#### Effect on the Doppler Spectrogram and Time-Domain Signal

The received noisy signal can be expressed as:

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) + A_{\text{elec}} \cos(2\pi f_{\text{elec}} t + \phi)
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $A_{\text{elec}}$ is the amplitude of the electrical interference.
- $f_{\text{elec}} = 60$ Hz (or 50 Hz) is the power line frequency.
- $\phi$ is a phase offset.

##### How Power Line Noise Contributes to the Doppler Signal

At a single frequency is siuper imposed on the Doippler signal.

##### How to Remove Power Line Noise

Since it is a single frequency, a notch filter tuned to the frequency ill eliminate that section. Wavelet demoising is a more advanced technique which can help.

#### Speckle Noise
Speckle noise is a granular, high-frequency noise that occurs due to interference of scattered ultrasound waves. It is a multiplicative and can be caused by choerent wave interference (waves scattering of scrtuctures), phase diferences between scattering paths, and tissue texture variations which affect acoustic impedance.

##### How Speckle Noise Contributes to the Doppler Signal
Unlike thermal noise (which is additive), speckle noise is multiplicative, meaning it affects the signal strength depending on the amplitude of the underlying signal.

#### Effect on the Doppler Spectrogram and Time-Domain Signal
In the Time-Domain, the Doppler signal experiences random amplitude fluctations, appearing to fade iun and out making weak blood flow/signal difficult to detect. In the Frequency-Domain, due to the non-sigular frequency effect, it appears as broad-band noise distroting spectral energy across various frequencies.

$$
s_{\text{noisy}}(t) = s_{\text{doppler}}(t) \cdot (1 + n_{\text{speckle}}(t))
$$

where:
- $s_{\text{doppler}}(t)$ is the clean Doppler signal.
- $n_{\text{speckle}}(t)$ is a random noise process, often modeled as a Rayleigh or log-normal distribution.

![output (2)](https://github.com/user-attachments/assets/750e4d03-37c4-4273-8a6c-d879d9f31d5e)

##### How to Remove Speckle Noise
Median filtering reduces localized speckle effects, but more robust techniques include wavelet denoising and adaptive filtering. Log compression can also make it easier to filter as it converts multiplicative noise into additive noise which is easier to filter.

### Further Notes for Noise Implementation
In a realistic Doppler ultrasound scenario, all these noise sources occur simultaneously but affect the signal at different stages of acquisition. To simulate noise realistically, a specific order is chosen to apply the noise. This is done to mimic the order these noise sources naturally affects the signal in a real ultrasound system.

1. Clutter Noise
- Clutter comes from large moving tissues (vessel walls, probe motion), which interfere with the received Doppler signal before it is processed.
- A low-frequ4ency sinusoid is added (~0.5-1.0) Hz with an amplitude larger than
2. Power Line Interference
- Power line noise  is introduced by nearby electrical sources before digitization. A 60 Hz sinusoidal component as added to the Doppler Signal.
3. Thermal Noise
- Thermal noise originates from hardware components (amplifiers, sensors, ADC quantization errors) and is typically added right before or during digitization. Gaussian white noise is added dependant on a sigma value.
4. Speckle Noise
-  Speckle noise is an acoustic interference effect that happens after wave propagation and scattering in tissue. It appears multiplicatively on the received signal as a Rayleigh-distributed random noise factor multiplied to the signal.

---

## Background

### Doppler Effect in Ultrasound Imaging
The Doppler effect describes the frequency shift that occurs when ultrasound waves reflect off moving blood cells. The relationship between the transmitted frequency, received frequency, and velocity of moving particles is given by the following equation:

$f_d = \frac{2 f_t v \cos(\theta)}{c}$

Where:  
- $f_d$ = Doppler shift (Hz)  
- $f_t$ = Transmitted frequency (Hz)  
- $v$ = Blood flow velocity (m/s)  
- $&theta;$ = Angle between ultrasound beam and blood flow direction (degrees)  
- $c$ = Speed of sound in biological tissue (~1540 m/s)  

### Types of Doppler Ultrasound
- **Continuous Wave (CW) Doppler:** Constant wave transmission and reception for high-velocity detection.
- **Pulsed Wave (PW) Doppler:** Short bursts of ultrasound to measure velocity at specific depths.

---

### Transmitted Signal

This figure shows the clean transmitted ultrasound signal at $f = 5 kHz$. This is significantly lower than an ultrasound transducer but reduced computational load.
![ultra1](https://github.com/user-attachments/assets/9f954ee6-d6b0-42be-998f-81a564d84344)

The received signal includes the effects of  Gaussian noise, powerline interference (50 Hz), motion artifacts (0.5 Hz), and harmonic distrotion.

#### Denoising and FFT
A Wavelet Transform and FIR filter is applied. FIR is chosen for a high order due to stability and no phase distortion which are important for medical signal analysis.

![ultra2](https://github.com/user-attachments/assets/6b08addf-0cae-48f9-9357-7f622780e5a5)

### Spectrogram of Noisy Signal
A time-frequency representation of the received signal, illustrating how different frequency components evolve over time.

![spectrogram-noisy](https://github.com/user-attachments/assets/c8129ba2-d032-4ba1-8efa-a5101cdc1e0f)

### Filtering
The received signal after applying notch filtering (to remove 50 Hz powerline noise), high-pass filtering (to remove motion artifacts), and low-pass filtering (to suppress high-frequency noise).

![recieved-filter](https://github.com/user-attachments/assets/e24b0cf1-84e3-439b-990e-de04f0130dad)

### Frequency Spectrum and Spectrogram of Filtered Signal
FFT analysis of the filtered signal, showing suppression of unwanted noise while retaining the Doppler frequency component.

####Key Observations:
- The 50 Hz powerline noise and high-frequency components are effectively removed.
- The Doppler shift peak is the only remaining distinguishable peak.
- Spectrogram is significantly clearer.

![fft-recieved-after-filter](https://github.com/user-attachments/assets/bcee7f88-a887-4f99-b5c8-ec240c4788f3)

![spectrogram-after-filter](https://github.com/user-attachments/assets/0120abf7-3860-4090-8c10-c8c223868507)

### Denoising Efficacy
After denoising, the doppler shift frequency is estimated at 2001000 Hz or 2.001 MHz. This error can be attributatble to memory errors in operating with large numbers on computers. Comparing the two signals, we can calculate the signal to noise ration before and after filtering to get a beter idea of how well teh filters worked.

![filtered-compare](https://github.com/user-attachments/assets/3fd5e53d-73b4-4048-98dc-2669c774adc2)

SNR before filtering = 0.28 dB
SNR after filtering = 2.09 dB

The blood flow is estimated after denoising and tested at different angles:
![image](https://github.com/user-attachments/assets/0363a12a-900b-4a42-a612-b1dc1b2ea3c8)




# Wavelet.m

## Explaination

Created a clean signal with a high sampling frequency for good resultion.
- Clean signal is made up of two sine waves, a 10 Hz dominant component, and a weaker 50 Hz component.
- Simulates often multiple frequencies pick up in ultrasound.

Adding Gaussian Noise for simplicity. More types of noise could include cable hum at (60 Hz).

This code uses Daubechies wavelet which is wellp-suited for biomedical signals and smooth oscilations. 
- Decomposition levels need to be set by balancing detail retentions vs noise remova. More noise can be removed with a higher value but with greater distortion.

Use wdenoise() to apply thresholding at ewach wavelet decomposition level. 'UniversalThreshold' adapts the threshold level based on noise statistics.

## Results

Note the importance in choosing a decomposition level. In this example, 2 seems to be the ideal level.
![Wavelets](https://github.com/user-attachments/assets/687bfeac-b091-4ea4-a676-686bbaa52bbc)

# FIR_IRR.m

## Explaination

Creating a FIR 
- Order 50; A higher order means smoother frequency response but results in a larger computational load.
- A cutoff frequency for the FIR is set at 30 Hz and normalized using thesampling frequency to remove frequency components greater than 30 Hz.
- FIR filter tyle is set to fir1 (Window Method) for simplicity

Creating IIR
- Order 4; Low compared to FIR, meaning more efficient.
- Using a butterworth fitlter to avoid ripple in the passband. Smooth frequency response.
- Cutoff at 30 Hz.

## Results

Note similar results due to the relatively uncomplex signal. Difference mostly lies in computational load in this example.
![FIRR-IRR](https://github.com/user-attachments/assets/144fe95a-b2ea-4849-b838-94d3b274777a)

___

## Summary of Key Observations

| **Method**              | **Pros**                                                   | **Cons**                                                  |
|-------------------------|-----------------------------------------------------------|-----------------------------------------------------------|
| **Wavelet Denoising**   | - Preserves signal structure  <br> - Adaptive filtering <br> - Effective for non-stationary noise | - Requires proper **wavelet selection & thresholding** |
| **FIR Filtering**       | - Linear phase response (**no distortion**) <br> - Smooth filtering | - Requires a **high filter order**, making it computationally intensive |
| **IIR Filtering**       | - Lower filter order (**more efficient**) <br> - Better attenuation at high frequencies | - Can introduce **phase distortion** |

For image processing, biosignals, and audio processing use FIR filter. Especially important for Real-time digital signal processing and RADAR.They are more stable as they dont use feedback.

For contorl systems use IIR. The lower computational load makes them ideal for embedded systems. Good for low-latency filtering. Can be unstable (unbounded signal/oscillating outputs) due to feedback loops and can introduce phase distrotion making them less ideal for imaging.

___
